$(function(){jQuery.event.props.push("dataTransfer");window.FileReader&&"WebGLRenderingContext"in window&&window.Worker?initWith3DViewer():($("#non-capable").removeClass("hidden"),$("#introduction").addClass("hidden"))});function initWith3DViewer(){$("#uploadButton").click(fileSelect);$("#inputFile").change(selectedFileFromInputForm);$("#dropArea").bind("dragover",onDragOver);$("#dropArea").bind("dragleave",onDragLeave);$("#dropArea").bind("drop",onDrop)} function fileSelect(){$("#inputFile").click();return!1}function selectedFileFromInputForm(a){start3DView(a.target.files[0])}function onDragOver(a){a.preventDefault();a.dataTransfer.dropEffect="copy";$("#dropArea").addClass("dragOver")}function onDragLeave(a){$("#dropArea").removeClass("dragOver")}function onDrop(a){a.preventDefault();$("#dropArea").removeClass("dragOver");start3DView(a.dataTransfer.files[0])}var renderer,camera,scene,light,sublight,ambientLight,geometry,mesh,trackball,worker; function start3DView(a){1>a.name.search(".stl")?alert("\u8aad\u307f\u8fbc\u3081\u308b\u306e\u306f.stl\u5f62\u5f0f\u306e\u30d5\u30a1\u30a4\u30eb\u306e\u307f\u3067\u3059"):showThree(300,function(){renderer||initWithThree();buildingGeometry(a)})} function initWithThree(){var a,b;a=$("body").width();b=$("body").height();scene=new THREE.Scene;camera=new THREE.PerspectiveCamera(45,a/b,0.1,1E4);camera.position.z=250;light=new THREE.DirectionalLight(16777215,1);light.position.set(0,0,500).normalize();sublight=new THREE.PointLight(14737632,1);sublight.position.set(100,-500,-500).normalize();ambientLight=new THREE.AmbientLight(858993459);scene.add(camera);scene.add(light);scene.add(sublight);scene.add(ambientLight);renderer=new THREE.WebGLRenderer({preserveDrawingBuffer:!0}); renderer.setSize(a,b);trackball=new THREE.TrackballControls(camera,renderer.domElement);trackball.addEventListener("change",trackballHack);$("#canvasBox").append(renderer.domElement);$("#camera").click(captureCanvas);$("#dustbox").click(returnHome);$(".colorbox").click(changeMeshMaterial);$(window).resize(handleResize)} function buildingGeometry(a){worker||(worker=new Worker("js/createGeometry.min.js"),worker.onmessage=function(a){var b=a.data.vertices,c=a.data.faces;a=a.data.boundBox;for(var g in b){var e=b[g].position;b[g]=new THREE.Vector3(e.x,e.y,e.z)}for(g in c){e=c[g];c[g]=new THREE.Face3(e.a,e.b,e.c);var h=b[c[g].a],f=b[c[g].b],d=b[c[g].c],e=(h.y-d.y)*(f.z-d.z)-(h.z-d.z)*(f.y-d.y),l=(h.z-d.z)*(f.x-d.x)-(h.x-d.x)*(f.z-d.z),h=(h.x-d.x)*(f.y-d.y)-(h.y-d.y)*(f.x-d.x),f=Math.sqrt(Math.pow(e,2)+Math.pow(l,2)+Math.pow(h, 2));c[g].normal={x:e/f,y:l/f,z:h/f}}geometry=new THREE.Geometry;geometry.vertices=b;geometry.faces=c;b=new THREE.MeshLambertMaterial({color:16118758,ambient:0});mesh=new THREE.Mesh(geometry,b);b=new THREE.Vector3;b.x=(a.maxX+a.minX)/2;b.y=(a.maxY+a.minY)/2;b.z=(a.maxZ+a.minZ)/2;b=b.sub(new THREE.Vector3);mesh.translateX(-b.x);mesh.translateY(-b.y);mesh.translateZ(-b.z);$("#loadingWindow").fadeOut(300).promise().done(function(){$("#extendsPanel").animate({opacity:1,left:0},"normal",function(){scene.add(mesh); animate3D();$("#canvasBox").fadeIn(300)})});worker.terminate();worker=null});var b=new FileReader;b.onload=function(b){b=b.target.result;var k=b.split(/[\n,\r]/g),c={line:k,file:b,orgData:a,type:"ASCII"};k[0].match(/solid/)?worker.postMessage(c):(b=new FileReader,b.onload=function(a){c.orgData=a.target.result;c.type="Binary";worker.postMessage(c)},b.readAsArrayBuffer(a))};b.readAsBinaryString(a)}function animate3D(){requestAnimationFrame(animate3D);render()} function render(){trackball.update();renderer.render(scene,camera)}function trackballHack(a){light.position=camera.position.clone().multiplyScalar(0.3,0.3,0.3);renderer.render(scene,camera)}function captureCanvas(){var a=$("#canvasBox > canvas")[0];$("<canvas />");a=a.toDataURL();$("#photoPanel > #photo").attr("src",a);$("#downloadImage").attr("href",a);$("#photoBackground").fadeIn(300).click(function(a){"photoPanel"!=$(a.target).attr("id")&&$(this).fadeOut(300)})} function changeMeshMaterial(a){a=$(a.target).css("backgroundColor");var b=$.fmtColor(a);a=parseInt(b.substr(1,2),16)/255;var m=parseInt(b.substr(3,2),16)/255,b=parseInt(b.substr(5,2),16)/255;mesh.material.color.setRGB(a,m,b)}function handleResize(a){a=$(window).width();var b=$(window).height();renderer.setSize(a,b);camera.aspect=a/b;camera.updateProjectionMatrix()} function showThree(a,b){$("#canvasBox").hide();$("#explanation").fadeOut(a).promise().done(function(){$("#loadingWindow").fadeIn(a).promise().done(function(){b&&b()})})}function returnThree(a,b){$("#explanation").hide();$("#canvasBox").fadeOut(a).promise().done(function(){$("#explanation").fadeIn(a);b&&b()})}function returnHome(a){$("#extendsPanel").animate({opacity:0,left:-300},300,function(){returnThree(300,function(){scene.remove(mesh)})})};
